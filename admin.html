<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Quản lý Tour du lịch</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Định dạng tổng thể cho trang */
        body {
            display: flex;
            font-family: 'Arial', sans-serif;
            background-color: #f5f7f8;
        }

        /* Thanh sidebar */
        .sidebar {
            width: 250px;
            height: 100vh;
            background: #007bff;
            color: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .sidebar h4 {
            margin-bottom: 20px;
            text-align: center;
        }

        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 12px;
            border-radius: 5px;
            transition: background 0.3s, transform 0.2s;
        }

        .sidebar a.active,
        .sidebar a:hover {
            background: #3f42d2cb;
            font-weight: bold;
            transform: scale(1.05);
        }

        /* Phần nội dung chính */
        .content {
            flex-grow: 1;
            padding: 20px;
            background-color: #e0f2f7;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(40, 30, 167, 0.1);
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .table th, .table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            color: black;
            font-size: 1rem;
        }

        .table th {
            background-color: #ddd;
            color: black;
            font-size: 1.1rem;
        }

        /* Cải thiện hiển thị trạng thái thanh toán */
        .status-select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }

        .status-select option[value="SUCCESS"] {
            background-color: #28a745;
            color: white;
        }

        .status-select option[value="PENDING"] {
            background-color: #ffc107;
            color: black;
        }

        .status-select option[value="FAILED"] {
            background-color: #dc3545;
            color: white;
        }

        /* Áp dụng màu sắc cho dropdown dựa trên giá trị đã chọn */
        .status-select.success {
            background-color: #28a745;
            color: white;
        }

        .status-select.pending {
            background-color: #ffc107;
            color: black;
        }

        .status-select.failed {
            background-color: #dc3545;
            color: white;
        }

        .status-select:hover {
            opacity: 0.9;
        }

        .save-btn {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            background-color: #4A90E2;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .save-btn:hover {
            background-color: #357ABD;
        }

        .hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                text-align: center;
            }
            .content {
                padding: 10px;
            }
        }

        /* Thẻ thống kê */
        .stats-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            width: 200px;
            margin-bottom: 20px;
        }

        .stat-card h3 {
            margin-bottom: 10px;
            color: black;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .stat-card p {
            font-size: 1rem;
        }

        /* Kiểu dáng cho nút chào mừng */
        .welcome-button {
            background-color: white;
            color: #050708;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.3rem;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s;
            width: 880px;
            text-align: left;
        }

        .welcome-button:hover {
            background-color: #f0f3f7;
        }

        /* Lớp mờ toàn trang */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        /* Form thêm/sửa tour */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
            width: 400px;
        }

        .modal h3 {
            margin-bottom: 20px;
            text-align: center;
        }

        .modal input, .modal textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .modal button {
            width: 48%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal .btn-save {
            background: #28a745;
            color: white;
        }

        .modal .btn-cancel {
            background: #dc3545;
            color: white;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="text-center">
            <img src="img/logo-KTX.png" alt="Logo" class="img-fluid mb-2" style="max-width: 100px;">
        </div>
        <h4>KTX Admin</h4>
        <ul class="list-unstyled">
            <li><a href="#" class="active" onclick="showContent(event, 'dashboard')"> <i class="fas fa-tachometer-alt"></i> Trang tổng quan</a></li>
            <li><a href="#" onclick="showContent(event, 'customers')"> <i class="fas fa-users"></i> Khách hàng</a></li>
            <li><a href="#" onclick="showContent(event, 'destinations')"> <i class="fas fa-map-marker-alt"></i> Quản lý Tour</a></li>
            <li><a href="#" onclick="showContent(event, 'tour-packages')"> <i class="fas fa-box"></i> Quản lý Đặt Tour</a></li>
            <li><a href="#" onclick="showContent(event, 'orders')"> <i class="fas fa-shopping-cart"></i> Báo Cáo & Thống Kê</a></li>
            <!-- <li><a href="#" onclick="showContent(event, 'contact-messages')"> <i class="fas fa-envelope"></i> Tin nhắn liên hệ</a></li> -->
        </ul>
    </div>

    <div class="content">
        <button class="welcome-button">Chào mừng, Quản trị viên!</button>

        <!-- Trang Tổng Quan -->
        <div id="dashboard">
            <h2>Trang Tổng Quan</h2>
            <div class="stats-container">
                <div class="stat-card tours">
                    <h3>Tổng số tour</h3>
                    <p id="total-tours">Đang tải...</p>
                </div>
                <div class="stat-card bookings">
                    <h3>Tổng số đặt tour</h3>
                    <p id="total-bookings">Đang tải...</p>
                </div>
                <div class="stat-card customers">
                    <h3>Tổng số khách hàng</h3>
                    <p id="total-customers">Đang tải...</p>
                </div>
                <div class="stat-card revenue">
                    <h3>Tổng doanh thu</h3>
                    <p id="total-revenue">Đang tải...</p>
                </div>
            </div>
        </div>

        <!-- Quản lý Khách Hàng -->
        <div id="customers" class="hidden">
            <h2>Khách Hàng</h2>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Họ và Tên</th>
                            <th>Email</th>
                            <th>Số Điện Thoại</th>
                            <th>Tên Tour</th>
                            <th>Ngày Đặt Tour</th>
                            <th>Ngày Khởi Hành</th>
                            <th>Trạng thái thanh toán</th>
                        </tr>
                    </thead>
                    <tbody id="customers-table-body">
                        <tr><td colspan="7">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Quản lý Đặt Tour -->
        <div id="tour-packages" class="hidden">
            <h2>Quản lý Đặt Tour</h2>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên đơn hàng</th>
                            <th>Số tiền</th>
                            <th>Trạng thái thanh toán</th>
                            <th>Ngày tạo</th>
                            <th>Tên khách hàng</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="bookings-table-body">
                        <tr><td colspan="7">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Báo Cáo & Thống Kê -->
        <div id="orders" class="hidden">
            <h2>Báo Cáo & Thống Kê</h2>
            <div class="card">
                <h3>Doanh thu theo tháng</h3>
                <canvas id="revenue-chart" width="400" height="200"></canvas>
            </div>
            <div class="card">
                <h3>Số lượng đặt tour theo tháng</h3>
                <canvas id="bookings-chart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Quản lý Tour -->
        <div id="destinations" class="hidden">
            <h2>Quản lý Tour</h2>
            <button class="btn btn-primary mb-3" onclick="showAddTourForm()">Thêm Tour Mới</button>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên Tour</th>
                            <th>Giá</th>
                            <th>Mô tả</th>
                            <th>Link Ảnh</th>
                            <th>Khách Sạn</th>
                            <th>Phương Tiện</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="tours-table-body">
                        <tr><td colspan="8">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tin nhắn liên hệ -->
        <div id="contact-messages" class="hidden">
            <h2>Tin nhắn liên hệ</h2>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Nội dung tin nhắn</th>
                            <th>Thời gian gửi</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="contact-messages-table-body">
                        <tr><td colspan="5">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Form thêm tour -->
        <div id="add-tour-modal" class="modal">
            <h3>Thêm Tour Mới</h3>
            <input type="text" id="add-tour-title" placeholder="Tên Tour" required>
            <input type="text" id="add-tour-price" placeholder="Giá (VD: 4200000)" required>
            <textarea id="add-tour-description" placeholder="Mô tả" rows="4"></textarea>
            <input type="url" id="add-tour-url" placeholder="Link ảnh">
            <input type="text" id="add-tour-hotel" placeholder="Khách sạn">
            <input type="text" id="add-tour-transport" placeholder="Phương tiện">
            <button class="btn-save" onclick="addTour()">Lưu</button>
            <button class="btn-cancel" onclick="closeAddTourForm()">Hủy</button>
        </div>

        <!-- Form sửa tour -->
        <div id="edit-tour-modal" class="modal">
            <h3>Sửa Tour</h3>
            <input type="hidden" id="edit-tour-id">
            <input type="text" id="edit-tour-title" placeholder="Tên Tour" required>
            <input type="text" id="edit-tour-price" placeholder="Giá (VD: 4200000)" required>
            <textarea id="edit-tour-description" placeholder="Mô tả" rows="4"></textarea>
            <input type="url" id="edit-tour-url" placeholder="Link ảnh">
            <input type="text" id="edit-tour-hotel" placeholder="Khách sạn">
            <input type="text" id="edit-tour-transport" placeholder="Phương tiện">
            <button class="btn-save" onclick="updateTour()">Lưu</button>
            <button class="btn-cancel" onclick="closeEditTourForm()">Hủy</button>
        </div>

        <div class="overlay"></div>
    </div>

    <script>
        // Hàm chuyển đổi nội dung hiển thị
        function showContent(event, id) {
            document.querySelectorAll('.content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if (id === 'dashboard') loadDashboard();
            if (id === 'customers') loadCustomers();
            if (id === 'tour-packages') loadBookings();
            if (id === 'orders') loadReports();
            if (id === 'destinations') loadTours();
            if (id === 'contact-messages') loadContactMessages();
        }

        // Hàm định dạng ngày tháng
        function formatDate(dateString) {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                return 'Không xác định';
            }
            return date.toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Tải dữ liệu cho Trang tổng quan
        async function loadDashboard() {
            try {
                const response = await fetch('http://localhost:5500/api/dashboard');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();

                document.getElementById('total-tours').textContent = data.totalTours || 0;
                document.getElementById('total-bookings').textContent = data.totalBookings || 0;
                document.getElementById('total-customers').textContent = data.totalCustomers || 0;
                document.getElementById('total-revenue').textContent = (data.totalRevenue || 0).toLocaleString('vi-VN') + ' VNĐ';
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu Dashboard:', error);
                alert('Lỗi khi tải dữ liệu Dashboard: ' + error.message);
            }
        }

        // Tải dữ liệu cho danh sách khách hàng
        async function loadCustomers() {
            try {
                const response = await fetch('http://localhost:5500/api/customers');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const customers = await response.json();

                const tbody = document.getElementById('customers-table-body');
                tbody.innerHTML = '';

                if (customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">Không có dữ liệu khách hàng</td></tr>';
                    return;
                }

                customers.forEach(customer => {
                    const statusClass = customer.payment_status === 'SUCCESS' ? 'success' :
                                       customer.payment_status === 'FAILED' ? 'failed' : 'pending';
                    const statusText = customer.payment_status === 'SUCCESS' ? 'Thành công' :
                                      customer.payment_status === 'FAILED' ? 'Thất bại' : 'Đang chờ';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.name || 'N/A'}</td>
                        <td>${customer.email || 'N/A'}</td>
                        <td>${customer.phone || 'N/A'}</td>
                        <td>${customer.order_name || 'Chưa đặt tour'}</td>
                        <td>${formatDate(customer.booking_date)}</td>
                        <td>${customer.departure_date ? formatDate(customer.departure_date) : 'N/A'}</td>
                        <td>
                            <select class="status-select ${statusClass}">
                                <option value="PENDING" ${customer.payment_status === 'PENDING' ? 'selected' : ''}>Đang chờ</option>
                                <option value="SUCCESS" ${customer.payment_status === 'SUCCESS' ? 'selected' : ''}>Thành công</option>
                                <option value="FAILED" ${customer.payment_status === 'FAILED' ? 'selected' : ''}>Thất bại</option>
                            </select>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu khách hàng:', error);
                alert('Lỗi khi tải dữ liệu khách hàng: ' + error.message);
            }
        }

        // Tải dữ liệu cho danh sách đặt tour
        async function loadBookings() {
            try {
                const response = await fetch('http://localhost:5500/api/bookings');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const bookings = await response.json();

                const tbody = document.getElementById('bookings-table-body');
                tbody.innerHTML = '';

                if (bookings.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">Không có dữ liệu đặt tour</td></tr>';
                    return;
                }

                bookings.forEach(booking => {
                    const statusClass = booking.payment_status === 'SUCCESS' ? 'success' :
                                        booking.payment_status === 'FAILED' ? 'failed' : 'pending';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.id}</td>
                        <td>${booking.order_name}</td>
                        <td>${booking.amount.toLocaleString('vi-VN')} VNĐ</td>
                        <td>
                            <select class="status-select ${statusClass}" data-id="${booking.id}">
                                <option value="PENDING" ${booking.payment_status === 'PENDING' ? 'selected' : ''}>Đang chờ</option>
                                <option value="SUCCESS" ${booking.payment_status === 'SUCCESS' ? 'selected' : ''}>Thành công</option>
                                <option value="FAILED" ${booking.payment_status === 'FAILED' ? 'selected' : ''}>Thất bại</option>
                            </select>
                        </td>
                        <td>${formatDate(booking.booking_date)}</td>
                        <td>${booking.customer_name}</td>
                        <td>
                            <button class="btn btn-primary save-btn" data-id="${booking.id}">Lưu</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Gắn sự kiện click cho các nút "Lưu"
                document.querySelectorAll('.save-btn').forEach(button => {
                    button.addEventListener('click', async function () {
                        const bookingId = this.getAttribute('data-id');
                        const select = document.querySelector(`.status-select[data-id="${bookingId}"]`);
                        const newStatus = select.value;

                        try {
                            const response = await fetch(`http://localhost:5500/api/bookings/${bookingId}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ payment_status: newStatus }),
                            });

                            const result = await response.json();
                            if (response.ok) {
                                alert('Cập nhật trạng thái thành công!');
                                loadBookings(); // Tải lại danh sách
                            } else {
                                console.error('Phản hồi lỗi từ API:', result);
                                alert('Lỗi khi cập nhật trạng thái: ' + (result.error || 'Không xác định'));
                            }
                        } catch (error) {
                            console.error('Lỗi khi cập nhật trạng thái:', error);
                            alert('Đã có lỗi xảy ra khi cập nhật trạng thái: ' + error.message);
                        }
                    });
                });

                // Cập nhật màu sắc của dropdown khi trạng thái thay đổi
                document.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', function () {
                        this.classList.remove('success', 'pending', 'failed');
                        if (this.value === 'SUCCESS') {
                            this.classList.add('success');
                        } else if (this.value === 'PENDING') {
                            this.classList.add('pending');
                        } else if (this.value === 'FAILED') {
                            this.classList.add('failed');
                        }
                    });
                });
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu đặt tour:', error);
                alert('Lỗi khi tải dữ liệu đặt tour: ' + error.message);
            }
        }

        // Tải dữ liệu cho báo cáo và thống kê
        async function loadReports() {
            try {
                const response = await fetch('http://localhost:5500/api/reports');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const reports = await response.json();

                const months = reports.map(item => item.month);
                const revenues = reports.map(item => item.revenue);
                const bookingCounts = reports.map(item => item.booking_count);

                // Biểu đồ doanh thu (Line Chart)
                const revenueChart = new Chart(document.getElementById('revenue-chart'), {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Doanh thu (VNĐ)',
                            data: revenues,
                            borderColor: 'blue',
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('vi-VN') + ' VNĐ';
                                    }
                                }
                            }
                        }
                    }
                });

                // Biểu đồ số lượng đặt tour (Bar Chart)
                const bookingsChart = new Chart(document.getElementById('bookings-chart'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Số lượng đặt tour',
                            data: bookingCounts,
                            backgroundColor: 'green'
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu báo cáo:', error);
                alert('Lỗi khi tải dữ liệu báo cáo: ' + error.message);
            }
        }

        // Tải dữ liệu cho danh sách tour
        async function loadTours() {
            try {
                const response = await fetch('http://localhost:5500/api/tours');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const tours = await response.json();

                const tbody = document.getElementById('tours-table-body');
                tbody.innerHTML = '';

                if (tours.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8">Không có dữ liệu tour</td></tr>';
                    return;
                }

                tours.forEach(tour => {
                    if (!tour.id) {
                        console.error('Tour không có ID:', tour);
                        return;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tour.id}</td>
                        <td>${tour.title}</td>
                        <td>${tour.price.toLocaleString('vi-VN')} VNĐ</td>
                        <td>${tour.description || 'N/A'}</td>
                        <td>${tour.url || 'N/A'}</td>
                        <td>${tour.hotel || 'N/A'}</td>
                        <td>${tour.transport || 'N/A'}</td>
                        <td>
                            <button class="btn btn-warning" 
                                    data-id="${tour.id}" 
                                    data-title="${tour.title ? tour.title.replace(/"/g, '"') : ''}" 
                                    data-price="${tour.price || ''}" 
                                    data-description="${tour.description ? tour.description.replace(/"/g, '"') : ''}" 
                                    data-url="${tour.url ? tour.url.replace(/"/g, '"') : ''}" 
                                    data-hotel="${tour.hotel ? tour.hotel.replace(/"/g, '"') : ''}" 
                                    data-transport="${tour.transport ? tour.transport.replace(/"/g, '"') : ''}" 
                                    onclick="showEditTourFormFromButton(this)">Sửa</button>
                            <button class="btn btn-danger" 
                                    data-id="${tour.id}" 
                                    onclick="deleteTourFromButton(this)">Xóa</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu tour:', error);
                alert('Lỗi khi tải dữ liệu tour: ' + error.message);
            }
        }

        // Tải dữ liệu cho danh sách tin nhắn liên hệ
        async function loadContactMessages() {
    try {
        const response = await fetch('http://localhost:3000/api/contact-messages');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const messages = await response.json();

        const tbody = document.getElementById('contact-messages-table-body');
        tbody.innerHTML = '';

        if (messages.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Không có tin nhắn liên hệ</td></tr>';
            return;
        }

        messages.forEach((message, index) => {
            const statusClass = message.status === 'RESOLVED' ? 'success' : 'pending';
            const statusText = message.status === 'RESOLVED' ? 'Đã xử lý' : 'Chưa xử lý';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${message.message}</td>
                <td>${formatDate(message.created_at)}</td>
                <td>
                    <select class="status-select ${statusClass}" data-id="${message.id}">
                        <option value="PENDING" ${message.status === 'PENDING' ? 'selected' : ''}>Chưa xử lý</option>
                        <option value="RESOLVED" ${message.status === 'RESOLVED' ? 'selected' : ''}>Đã xử lý</option>
                    </select>
                </td>
                <td>
                    <button class="save-btn" data-id="${message.id}">Lưu</button>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Gắn sự kiện cho các nút "Lưu"
        document.querySelectorAll('.save-btn').forEach(button => {
            button.addEventListener('click', async function () {
                const messageId = this.getAttribute('data-id');
                const select = document.querySelector(`.status-select[data-id="${messageId}"]`);
                const newStatus = select.value;

                try {
                    const response = await fetch(`http://localhost:3000/api/contact-messages/${messageId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ status: newStatus }),
                    });

                    const result = await response.json();
                    if (response.ok) {
                        alert('Cập nhật trạng thái tin nhắn thành công!');
                        loadContactMessages(); // Tải lại danh sách
                    } else {
                        throw new Error(result.error || 'Lỗi khi cập nhật trạng thái');
                    }
                } catch (error) {
                    console.error('Lỗi khi cập nhật trạng thái:', error);
                    alert('Lỗi khi cập nhật trạng thái: ' + error.message);
                }
            });
        });

        // Cập nhật màu sắc của dropdown khi trạng thái thay đổi
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', function () {
                this.classList.remove('success', 'pending');
                this.classList.add(this.value === 'RESOLVED' ? 'success' : 'pending');
            });
        });
    } catch (error) {
        console.error('Lỗi khi tải dữ liệu tin nhắn:', error);
        alert('Lỗi khi tải dữ liệu tin nhắn: ' + error.message);
    }
}

        // Hàm hỗ trợ cho nút "Sửa"
        function showEditTourFormFromButton(button) {
            const id = button.getAttribute('data-id');
            const title = button.getAttribute('data-title');
            const price = button.getAttribute('data-price');
            const description = button.getAttribute('data-description');
            const url = button.getAttribute('data-url');
            const hotel = button.getAttribute('data-hotel');
            const transport = button.getAttribute('data-transport');
            showEditTourForm(id, title, price, description, url, hotel, transport);
        }

        // Hàm hỗ trợ cho nút "Xóa"
        function deleteTourFromButton(button) {
            const id = button.getAttribute('data-id');
            if (!id) {
                alert('Không tìm thấy ID của tour để xóa!');
                console.error('Nút Xóa không có data-id:', button);
                return;
            }
            deleteTour(id);
        }

        // Hiển thị form thêm tour
        function showAddTourForm() {
            document.getElementById('add-tour-modal').style.display = 'block';
            document.querySelector('.overlay').style.display = 'block';
        }

        // Đóng form thêm tour
        function closeAddTourForm() {
            document.getElementById('add-tour-modal').style.display = 'none';
            document.querySelector('.overlay').style.display = 'none';
            document.getElementById('add-tour-title').value = '';
            document.getElementById('add-tour-price').value = '';
            document.getElementById('add-tour-description').value = '';
            document.getElementById('add-tour-url').value = '';
            document.getElementById('add-tour-hotel').value = '';
            document.getElementById('add-tour-transport').value = '';
        }

        // Thêm tour mới
        async function addTour() {
            const title = document.getElementById('add-tour-title').value.trim();
            const price = document.getElementById('add-tour-price').value.trim();
            const description = document.getElementById('add-tour-description').value.trim();
            const url = document.getElementById('add-tour-url').value.trim();
            const hotel = document.getElementById('add-tour-hotel').value.trim();
            const transport = document.getElementById('add-tour-transport').value.trim();

            if (!title || !price) {
                alert('Vui lòng điền ít nhất Tên Tour và Giá!');
                return;
            }

            // Kiểm tra định dạng giá (chỉ chấp nhận số)
            const priceValue = parseInt(price.replace(/[^0-9]/g, ''));
            if (isNaN(priceValue) || priceValue <= 0) {
                alert('Giá phải là một số hợp lệ và lớn hơn 0!');
                return;
            }

            try {
                const response = await fetch('http://localhost:5500/api/tours', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        title, 
                        price: priceValue, 
                        description: description || null, 
                        url: url || null, 
                        hotel: hotel || null, 
                        transport: transport || null 
                    })
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();

                if (result.error) {
                    alert('Lỗi khi thêm tour: ' + result.error);
                    return;
                }

                alert('Thêm tour thành công!');
                closeAddTourForm();
                loadTours();
            } catch (error) {
                console.error('Lỗi khi thêm tour:', error);
                alert('Lỗi khi thêm tour: ' + error.message);
            }
        }

        // Hiển thị form sửa tour
        function showEditTourForm(id, title, price, description, url, hotel, transport) {
            document.getElementById('edit-tour-id').value = id;
            document.getElementById('edit-tour-title').value = title;
            document.getElementById('edit-tour-price').value = price;
            document.getElementById('edit-tour-description').value = description;
            document.getElementById('edit-tour-url').value = url;
            document.getElementById('edit-tour-hotel').value = hotel;
            document.getElementById('edit-tour-transport').value = transport;
            document.getElementById('edit-tour-modal').style.display = 'block';
            document.querySelector('.overlay').style.display = 'block';
        }

        // Đóng form sửa tour
        function closeEditTourForm() {
            document.getElementById('edit-tour-modal').style.display = 'none';
            document.querySelector('.overlay').style.display = 'none';
        }

        // Cập nhật tour
        async function updateTour() {
            const id = document.getElementById('edit-tour-id').value;
            const title = document.getElementById('edit-tour-title').value.trim();
            const price = document.getElementById('edit-tour-price').value.trim();
            const description = document.getElementById('edit-tour-description').value.trim();
            const url = document.getElementById('edit-tour-url').value.trim();
            const hotel = document.getElementById('edit-tour-hotel').value.trim();
            const transport = document.getElementById('edit-tour-transport').value.trim();

            if (!id || !title || !price) {
                alert('Vui lòng điền ít nhất Tên Tour và Giá!');
                return;
            }

            // Kiểm tra định dạng giá (chỉ chấp nhận số)
            const priceValue = parseInt(price.replace(/[^0-9]/g, ''));
            if (isNaN(priceValue) || priceValue <= 0) {
                alert('Giá phải là một số hợp lệ và lớn hơn 0!');
                return;
            }

            try {
                const response = await fetch(`http://localhost:5500/api/tours/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        title, 
                        price: priceValue, 
                        description: description || null, 
                        url: url || null, 
                        hotel: hotel || null, 
                        transport: transport || null 
                    })
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();

                if (result.error) {
                    alert('Lỗi khi sửa tour: ' + result.error);
                    return;
                }

                alert('Sửa tour thành công!');
                closeEditTourForm();
                loadTours();
            } catch (error) {
                console.error('Lỗi khi sửa tour:', error);
                alert('Lỗi khi sửa tour: ' + error.message);
            }
        }

        // Xóa tour
        async function deleteTour(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa tour này?')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:5500/api/tours/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();

                if (result.error) {
                    alert('Lỗi khi xóa tour: ' + result.error);
                    return;
                }

                alert('Xóa tour thành công!');
                loadTours();
            } catch (error) {
                console.error('Lỗi khi xóa tour:', error);
                alert('Lỗi khi xóa tour: ' + error.message);
            }
        }

        // Tải dữ liệu mặc định khi trang được tải
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });
    </script>
</body>
</html>