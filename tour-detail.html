<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Ti·∫øt Tour</title>
    <link rel="stylesheet" href="css/tour-detail.css">
    <script src="https://kit.fontawesome.com/d63bdcadb6.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Th√™m th∆∞ vi·ªán lazysizes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js" async></script>
    <link rel="stylesheet" href="css/chatbox.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
</head>
<body>
    <!-- N√∫t quay l·∫°i -->
    <a href="services.html" class="back-btn">
        <i class="fa-solid fa-arrow-left"></i> Quay l·∫°i
    </a>

    <header class="header">
        <h1 id="tour-title">Chi Ti·∫øt Tour</h1>
    </header>

    <section class="tour-details">
        <img id="tour-image" class="lazyload" data-src="" alt="·∫¢nh ch√≠nh c·ªßa tour">
        <p id="tour-description">Th√¥ng tin chi ti·∫øt v·ªÅ tour...</p>
    
        <h3>Th∆∞ vi·ªán ·∫£nh</h3>
        <div class="gallery" id="tour-gallery"></div>
        <p id="gallery-error" style="color: red; display: none;">M·ªôt s·ªë ·∫£nh kh√¥ng t·∫£i ƒë∆∞·ª£c.</p>
    
        <h3>L·ªãch tr√¨nh tour:</h3>
        <div class="itinerary-container" id="tour-itinerary"></div>
    
        <div class="transport-hotel-card" id="transport-hotel-info">
            <h3>Th√¥ng tin di chuy·ªÉn & ch·ªó ·ªü</h3>
            <p><strong>Ph∆∞∆°ng ti·ªán:</strong> <span id="tour-transport"></span></p>
            <p><strong>Kh√°ch s·∫°n:</strong> <span id="tour-hotel"></span></p>
        </div>
    
        <h3>Gi√° Tour:</h3>
        <p id="tour-price"></p>
    
        <a href="#" class="btn" id="book-now">ƒê·∫∑t ngay</a>
    </section>
    
    <!-- Th√™m chatbox -->
    <button class="chatbot-toggler">
        <span class="material-symbols-rounded"><img src="img/logo-KTX.png" alt="Chat"></span>
        <span class="material-symbols-outlined">close</span>
    </button>
    <div class="chatbot">
        <header class="chat-header">
            <h2>Chatbot</h2>
            <span class="close-btn material-symbols-outlined">close</span>
        </header>
        <ul class="chatbox">
            <li class="chat incoming">
                <span class="material-symbols-outlined">smart_toy</span>
                <p>Hi there üëã<br>How can I help you today?</p>
            </li>
        </ul>
        <div class="chat-input">
            <textarea placeholder="Enter a message..." spellcheck="false" required></textarea>
            <span id="send-btn" class="material-symbols-rounded">send</span>
        </div>
    </div>
    
    <script>

        document.addEventListener("DOMContentLoaded", () => {
            // L·∫•y ID t·ª´ URL
            const params = new URLSearchParams(window.location.search);
            const tourId = params.get("id");

            let tourData = null;

            // L·∫•y chi ti·∫øt tour t·ª´ API
            async function fetchTourDetails() {
                try {
                    const response = await fetch(`http://localhost:5500/tour/${tourId}`);
                    if (!response.ok) {
                        throw new Error("L·ªói khi l·∫•y chi ti·∫øt tour");
                    }
                    tourData = await response.json();
                    console.log("D·ªØ li·ªáu tour t·ª´ API:", tourData);
                    displayTourDetails(tourData);
                } catch (error) {
                    console.error("L·ªói:", error.message);
                    document.querySelector(".tour-details").innerHTML = "<p>Kh√¥ng t√¨m th·∫•y tour n√†y!</p>";
                }
            }

            // Hi·ªÉn th·ªã chi ti·∫øt tour
            function displayTourDetails(tour) {
                // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
                document.getElementById("tour-title").textContent = tour.title;

                // C·∫≠p nh·∫≠t ·∫£nh ch√≠nh
                const tourImage = document.getElementById("tour-image");
                if (tour.image && isValidURL(tour.image)) {
                    tourImage.setAttribute('data-src', tour.image);
                    tourImage.classList.add("lazyload");
                } else {
                    tourImage.style.display = "none"; // Kh√¥ng hi·ªÉn th·ªã n·∫øu URL kh√¥ng h·ª£p l·ªá
                    console.error(`Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh ch√≠nh: ${tour.image}`);
                }

                // C·∫≠p nh·∫≠t m√¥ t·∫£
                document.getElementById("tour-description").textContent = tour.description || "Kh√¥ng c√≥ m√¥ t·∫£.";

                // C·∫≠p nh·∫≠t gi√°
                document.getElementById("tour-price").textContent = `Gi√°: ${parseInt(tour.price.replace(/\D/g, '')).toLocaleString('vi-VN')} VNƒê`;

                // C·∫≠p nh·∫≠t th√¥ng tin di chuy·ªÉn v√† kh√°ch s·∫°n
                document.getElementById("tour-transport").textContent = tour.transport || "Kh√¥ng c√≥ th√¥ng tin";
                document.getElementById("tour-hotel").textContent = tour.hotel || "Kh√¥ng c√≥ th√¥ng tin";

                // L·ªãch tr√¨nh chi ti·∫øt
                const itineraryContainer = document.getElementById("tour-itinerary");
                let itinerary = [];
                if (tour.itinerary) {
                    try {
                        itinerary = typeof tour.itinerary === "string" ? JSON.parse(tour.itinerary) : tour.itinerary;
                    } catch (error) {
                        console.error("L·ªói khi parse itinerary:", error);
                        itinerary = [];
                    }
                }

                if (itinerary.length > 0) {
                    itinerary.forEach(day => {
                        const dayDiv = document.createElement("div");
                        dayDiv.classList.add("itinerary-day");

                        const dayTitle = document.createElement("h4");
                        dayTitle.textContent = day.day;
                        dayDiv.appendChild(dayTitle);

                        const activitiesList = document.createElement("ul");
                        day.activities.forEach(activity => {
                            const li = document.createElement("li");
                            li.textContent = activity;
                            activitiesList.appendChild(li);
                        });

                        dayDiv.appendChild(activitiesList);
                        itineraryContainer.appendChild(dayDiv);
                    });
                } else {
                    itineraryContainer.innerHTML = "<p>Kh√¥ng c√≥ l·ªãch tr√¨nh chi ti·∫øt.</p>";
                }

                // Th∆∞ vi·ªán ·∫£nh
                const galleryDiv = document.getElementById("tour-gallery");
                const galleryError = document.getElementById("gallery-error");
                let gallery = [];
                if (tour.gallery && Array.isArray(tour.gallery)) {
                    gallery = tour.gallery;
                }

                let hasError = false;
                if (gallery.length > 0) {
                    gallery.forEach(imgSrc => {
                        if (isValidURL(imgSrc)) {
                            const img = document.createElement("img");
                            img.classList.add("lazyload");
                            img.setAttribute('data-src', imgSrc);
                            img.alt = "·∫¢nh tour";
                            img.onerror = () => {
                                console.error(`Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh: ${imgSrc}`);
                                img.style.display = "none"; // ·∫®n ·∫£nh n·∫øu kh√¥ng t·∫£i ƒë∆∞·ª£c
                                hasError = true;
                                galleryError.style.display = "block";
                            };
                            galleryDiv.appendChild(img);
                        }
                    });
                } else {
                    galleryDiv.innerHTML = "<p>Kh√¥ng c√≥ ·∫£nh trong th∆∞ vi·ªán.</p>";
                }
            }

            // X·ª≠ l√Ω ƒë·∫∑t tour
            document.getElementById("book-now").addEventListener("click", function(event) {
                event.preventDefault();

                if (!tourData) {
                    alert("Tour kh√¥ng t·ªìn t·∫°i!");
                    return;
                }

                Swal.fire({
                    title: "X√°c nh·∫≠n ƒë·∫∑t tour",
                    html: `
                        <p>B·∫°n mu·ªën ƒë·∫∑t tour "<strong>${tourData.title}</strong>" v·ªõi gi√° <strong>${tourData.price}</strong>?</p>
                        <input type="text" id="user-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" required>
                        <input type="email" id="user-email" placeholder="Nh·∫≠p email c·ªßa b·∫°n" required>
                        <input type="tel" id="user-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>
                    `,
                    imageUrl: tourData.image && isValidURL(tourData.image) ? tourData.image : null,
                    imageWidth: 400,
                    imageAlt: "·∫¢nh tour",
                    showCancelButton: true,
                    confirmButtonText: "X√°c nh·∫≠n",
                    cancelButtonText: "H·ªßy",
                    preConfirm: () => {
                        const name = document.getElementById("user-name").value;
                        const email = document.getElementById("user-email").value;
                        const phone = document.getElementById("user-phone").value;
                        if (!name || !email || !phone) {
                            Swal.showValidationMessage("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n, email v√† s·ªë ƒëi·ªán tho·∫°i!");
                        }
                        return { name, email, phone };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const tourImage = tourData.image && isValidURL(tourData.image) ? tourData.image : null;
                        console.log("L∆∞u image v√†o localStorage:", tourImage);

                        localStorage.setItem("selectedTour", JSON.stringify({
                            product_id: tourData.id,
                            title: tourData.title,
                            price: tourData.price,
                            image: tourImage,
                            name: result.value.name,
                            email: result.value.email,
                            phone: result.value.phone
                        }));

                        window.location.href = "payment.html";
                    }
                });
            });

            // H√†m ki·ªÉm tra URL h·ª£p l·ªá
            function isValidURL(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }

            // G·ªçi h√†m l·∫•y chi ti·∫øt tour khi trang ƒë∆∞·ª£c t·∫£i
            fetchTourDetails();
        });
    </script>
    <script>
        // Ch√®n chatbox v√†o trang
        fetch('chatbox-component.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('chatbox-container').innerHTML = data;
                // Sau khi ch√®n, t·∫£i l·ªãch s·ª≠ tr√≤ chuy·ªán
                loadChatHistory();
                // Kh√¥i ph·ª•c tr·∫°ng th√°i hi·ªÉn th·ªã c·ªßa chatbox
                const isChatbotOpen = localStorage.getItem('chatbotOpen') === 'true';
                if (isChatbotOpen) {
                    document.body.classList.add('show-chatbot');
                }
            });
      </script>
    <script src="script.js"></script> <!-- Di chuy·ªÉn xu·ªëng cu·ªëi body -->
    
</body>
</html>