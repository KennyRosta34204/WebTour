<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh To√°n ZaloPay</title>
    <link rel="stylesheet" href="css/payment.css">
    <!-- Th√™m Font Awesome ƒë·ªÉ hi·ªÉn th·ªã icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Th√™m th∆∞ vi·ªán qrcode ƒë·ªÉ t·∫°o m√£ QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="css/chatbox.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <style>
        #payment-button {
            background-color: #6a1b9a;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            position: relative;
        }
        #payment-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #qrcode-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }
        #qrcode-container h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        #qrcode-container p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        #qrcode {
            text-align: center;
        }
        #qrcode canvas {
            max-width: 200px;
        }
        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6a1b9a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <a href="index.html">Trang ch·ªß</a>
        <a href="about.html">Gi·ªõi thi·ªáu</a>
        <a href="services.html">D·ªãch v·ª•</a>
        <a href="contact.html">Li√™n h·ªá</a>
        <i class="fa-solid fa-user"></i>
    </nav>

    <h2>Thanh To√°n Tour Du L·ªãch</h2>

    <div id="tour-info">
        <img id="tour-image" src="" alt="H√¨nh ·∫£nh tour" width="300">
        <p><strong>T√™n tour:</strong> <span id="tour-name"></span></p>
        <p><strong>Gi√° ti·ªÅn:</strong> <span id="tour-price"></span> VND</p>
        <p><strong>T√™n ng∆∞·ªùi d√πng:</strong> <span id="user-name"></span></p>
        <p><strong>Email:</strong> <span id="user-email"></span></p>
        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="user-phone"></span></p>
    </div>

    <button id="payment-button" onclick="createOrder()">
        Thanh To√°n
        <span class="loading-spinner"></span>
    </button>
    <div id="qrcode-container" style="display: none;">
        <h3>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n qua ZaloPay</h3>
        <p>Vui l√≤ng m·ªü ·ª©ng d·ª•ng ZaloPay v√† qu√©t m√£ QR b√™n d∆∞·ªõi ƒë·ªÉ ho√†n t·∫•t thanh to√°n.</p>
        <div id="qrcode"></div>
        <a id="open-zalopay" href="#" target="_blank">M·ªü ZaloPay ƒë·ªÉ thanh to√°n (n·∫øu kh√¥ng qu√©t ƒë∆∞·ª£c m√£ QR)</a>
    </div>

    <div id="chatbox-container"></div>

    <script>
        // Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng
        function checkNetwork() {
            return navigator.onLine;
        }

        // ƒê·∫£m b·∫£o ng∆∞·ªùi d√πng ph·∫£i ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi thanh to√°n
        document.addEventListener("DOMContentLoaded", function() {
            // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            const user_id = localStorage.getItem("user_id");
            if (!user_id) {
                alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thanh to√°n!");
                window.location.href = "login.html"; // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ƒëƒÉng nh·∫≠p
                return;
            }

            // Ti·∫øp t·ª•c hi·ªÉn th·ªã th√¥ng tin tour
            const tourData = JSON.parse(localStorage.getItem("selectedTour"));
            if (!tourData || !tourData.product_id) {
                alert("Kh√¥ng c√≥ tour n√†o ƒë∆∞·ª£c ch·ªçn ho·∫∑c thi·∫øu th√¥ng tin tour!");
                window.location.href = "services.html"; // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang danh s√°ch tour
                return;
            }

            console.log("D·ªØ li·ªáu tourData:", tourData);

            // Hi·ªÉn th·ªã th√¥ng tin tour
            document.getElementById("tour-name").textContent = tourData.title || "Kh√¥ng c√≥ th√¥ng tin";
            
            // ƒê·ªãnh d·∫°ng gi√° ti·ªÅn
            const price = parseInt(tourData.price?.replace(/\D/g, '') || '0');
            document.getElementById("tour-price").textContent = price.toLocaleString('vi-VN');

            // Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng
            document.getElementById("user-name").textContent = tourData.name || "Kh√¥ng c√≥ th√¥ng tin";
            document.getElementById("user-email").textContent = tourData.email || "Kh√¥ng c√≥ th√¥ng tin";
            document.getElementById("user-phone").textContent = tourData.phone || "Kh√¥ng c√≥ th√¥ng tin";

            // Hi·ªÉn th·ªã h√¨nh ·∫£nh tour
            const tourImage = document.getElementById("tour-image");
            const defaultImage = "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80";
            tourImage.src = tourData.image || defaultImage;
            tourImage.onerror = function() {
                console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh:", tourData.image);
                this.src = defaultImage;
            };

            // X·ª≠ l√Ω chatbox
            const chatbotToggler = document.querySelector(".chatbot-toggler");
            const chatbot = document.querySelector(".chatbot");
            const closeBtn = document.querySelector(".close-btn");
            const sendBtn = document.getElementById("send-btn");
            const chatInput = document.querySelector(".chat-input textarea");
            const chatbox = document.querySelector(".chatbox");

            if (chatbotToggler && chatbot) {
                chatbotToggler.addEventListener("click", () => {
                    chatbot.classList.toggle("active");
                });
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y chatbotToggler ho·∫∑c chatbot");
            }

            if (closeBtn && chatbot) {
                closeBtn.addEventListener("click", () => {
                    chatbot.classList.remove("active");
                });
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y closeBtn ho·∫∑c chatbot");
            }

            if (sendBtn && chatInput && chatbox) {
                sendBtn.addEventListener("click", () => {
                    const message = chatInput.value.trim();
                    if (message) {
                        const outgoingMsg = document.createElement("li");
                        outgoingMsg.classList.add("chat", "outgoing");
                        outgoingMsg.innerHTML = `<p>${message}</p>`;
                        chatbox.appendChild(outgoingMsg);
                        chatInput.value = "";
                        chatbox.scrollTop = chatbox.scrollHeight;

                        setTimeout(() => {
                            const incomingMsg = document.createElement("li");
                            incomingMsg.classList.add("chat", "incoming");
                            incomingMsg.innerHTML = `<span class="material-symbols-outlined">smart_toy</span><p>ƒêang x·ª≠ l√Ω...</p>`;
                            chatbox.appendChild(incomingMsg);
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }, 600);
                    }
                });

                // Th√™m s·ª± ki·ªán Enter ƒë·ªÉ g·ª≠i tin nh·∫Øn
                chatInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendBtn.click();
                    }
                });
            } else {
                console.error("Kh√¥ng t√¨m th·∫•y sendBtn, chatInput ho·∫∑c chatbox");
            }
        });

        // H√†m t·∫°o ƒë∆°n h√†ng v√† x·ª≠ l√Ω thanh to√°n
        async function createOrder() {
            const paymentButton = document.getElementById("payment-button");
            const loadingSpinner = paymentButton.querySelector(".loading-spinner");
            const qrCodeContainer = document.getElementById("qrcode-container");

            // Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng
            if (!checkNetwork()) {
                alert("Kh√¥ng c√≥ k·∫øt n·ªëi internet. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i!");
                return;
            }

            paymentButton.disabled = true;
            paymentButton.textContent = "ƒêang x·ª≠ l√Ω...";
            loadingSpinner.style.display = "block";

            const tourData = JSON.parse(localStorage.getItem("selectedTour"));
            if (!tourData) {
                alert("Kh√¥ng c√≥ d·ªØ li·ªáu tour!");
                paymentButton.disabled = false;
                paymentButton.textContent = "Thanh To√°n";
                loadingSpinner.style.display = "none";
                return;
            }

            try {
                // Ki·ªÉm tra product_id
                const product_id = tourData.product_id;
                if (!product_id) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y product_id trong d·ªØ li·ªáu tour");
                }

                // Ki·ªÉm tra th√¥ng tin ng∆∞·ªùi d√πng
                const userInfo = {
                    name: tourData.name || "Kh√°ch h√†ng",
                    email: tourData.email || "khachhang@example.com",
                    phone: tourData.phone || "0123456789"
                };

                if (!userInfo.name || !userInfo.email || !userInfo.phone) {
                    throw new Error("Th√¥ng tin ng∆∞·ªùi d√πng kh√¥ng ƒë·∫ßy ƒë·ªß. Vui l√≤ng ki·ªÉm tra l·∫°i!");
                }

                // Ki·ªÉm tra ƒë·ªãnh d·∫°ng email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(userInfo.email)) {
                    throw new Error("Email kh√¥ng h·ª£p l·ªá!");
                }

                // Ki·ªÉm tra ƒë·ªãnh d·∫°ng s·ªë ƒëi·ªán tho·∫°i
                const phoneRegex = /^\d{10,15}$/;
                if (!phoneRegex.test(userInfo.phone)) {
                    throw new Error("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (ph·∫£i c√≥ 10-15 ch·ªØ s·ªë)!");
                }

                // L·∫•y user_id t·ª´ localStorage
                const user_id = localStorage.getItem("user_id");
                if (!user_id) {
                    throw new Error("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c!");
                }

                console.log("üì§ G·ª≠i y√™u c·∫ßu t·∫°o ƒë∆°n h√†ng:", { product_id, userInfo, user_id });

                const response = await fetch("http://localhost:5500/create-order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ product_id, userInfo, user_id })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server");
                }

                const result = await response.json();
                console.log("üì© Ph·∫£n h·ªìi t·ª´ backend:", result);

                if (result.order_url) {
                    console.log("‚úÖ T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng! Hi·ªÉn th·ªã m√£ QR ZaloPay...");
                    // Hi·ªÉn th·ªã m√£ QR
                    const qrCodeDiv = document.getElementById("qrcode");
                    qrCodeDiv.innerHTML = ""; // X√≥a m√£ QR c≈© (n·∫øu c√≥)
                    QRCode.toCanvas(result.order_url, { width: 200 }, function (error, canvas) {
                        if (error) {
                            console.error("L·ªói khi t·∫°o m√£ QR:", error);
                            throw new Error("Kh√¥ng th·ªÉ t·∫°o m√£ QR!");
                        }
                        qrCodeDiv.appendChild(canvas);
                    });

                    // Hi·ªÉn th·ªã container ch·ª©a m√£ QR
                    qrCodeContainer.style.display = "block";

                    // C·∫≠p nh·∫≠t li√™n k·∫øt m·ªü ZaloPay
                    const openZaloPayLink = document.getElementById("open-zalopay");
                    openZaloPayLink.href = result.order_url;

                    // C·∫≠p nh·∫≠t n√∫t thanh to√°n
                    paymentButton.textContent = "Thanh To√°n L·∫°i";

                    // Ki·ªÉm tra tr·∫°ng th√°i thanh to√°n ƒë·ªãnh k·ª≥
                    const app_trans_id = result.app_trans_id;
                    checkPaymentStatus(app_trans_id);
                } else {
                    throw new Error(result.error || "T·∫°o ƒë∆°n h√†ng th·∫•t b·∫°i!");
                }
            } catch (error) {
                console.error("‚ùå L·ªói h·ªá th·ªëng:", error.message);
                alert(`L·ªói: ${error.message}`);
                paymentButton.textContent = "Thanh To√°n";
            } finally {
                paymentButton.disabled = false;
                loadingSpinner.style.display = "none";
            }
        }

        // H√†m ki·ªÉm tra tr·∫°ng th√°i thanh to√°n
        async function checkPaymentStatus(app_trans_id) {
            let attempts = 0;
            const maxAttempts = 30; // T·ªëi ƒëa 30 l·∫ßn th·ª≠ (60 gi√¢y)

            const interval = setInterval(async () => {
                attempts++;
                console.log(`üìã L·∫ßn th·ª≠ ${attempts}/${maxAttempts} - Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng...`);

                try {
                    const response = await fetch(`http://localhost:5500/order-status/${app_trans_id}`);
                    if (!response.ok) {
                        throw new Error(`Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log("üìã Tr·∫°ng th√°i ƒë∆°n h√†ng:", data);

                    if (data.status === "SUCCESS") {
                        clearInterval(interval); // D·ª´ng ki·ªÉm tra ƒë·ªãnh k·ª≥
                        console.log("‚úÖ Thanh to√°n th√†nh c√¥ng! Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß...");
                        // L∆∞u tr·∫°ng th√°i thanh to√°n th√†nh c√¥ng v√†o localStorage
                        localStorage.setItem("paymentSuccess", "true");
                        // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ch·ªß
                        window.location.href = "index.html";
                    } else if (data.status === "FAILED") {
                        clearInterval(interval); // D·ª´ng ki·ªÉm tra ƒë·ªãnh k·ª≥
                        console.log("‚ùå Thanh to√°n th·∫•t b·∫°i!");
                        alert("Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i!");
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval); // D·ª´ng ki·ªÉm tra n·∫øu v∆∞·ª£t qu√° s·ªë l·∫ßn th·ª≠
                        console.log("‚è∞ H·∫øt th·ªùi gian ch·ªù! Chuy·ªÉn h∆∞·ªõng th·ªß c√¥ng v·ªÅ trang ch·ªß...");
                        alert("Kh√¥ng th·ªÉ x√°c nh·∫≠n tr·∫°ng th√°i thanh to√°n. B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ trang ch·ªß.");
                        // L∆∞u tr·∫°ng th√°i thanh to√°n th√†nh c√¥ng v√†o localStorage (gi·∫£ ƒë·ªãnh th√†nh c√¥ng)
                        localStorage.setItem("paymentSuccess", "true");
                        window.location.href = "index.html";
                    }
                    // N·∫øu tr·∫°ng th√°i l√† PENDING, ti·∫øp t·ª•c ki·ªÉm tra
                } catch (error) {
                    console.error("‚ùå L·ªói khi ki·ªÉm tra tr·∫°ng th√°i:", error.message);
                    if (attempts >= maxAttempts) {
                        clearInterval(interval); // D·ª´ng ki·ªÉm tra n·∫øu v∆∞·ª£t qu√° s·ªë l·∫ßn th·ª≠
                        console.log("‚è∞ H·∫øt th·ªùi gian ch·ªù do l·ªói! Chuy·ªÉn h∆∞·ªõng th·ªß c√¥ng v·ªÅ trang ch·ªß...");
                        alert("C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra tr·∫°ng th√°i thanh to√°n. B·∫°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ trang ch·ªß.");
                        // L∆∞u tr·∫°ng th√°i thanh to√°n th√†nh c√¥ng v√†o localStorage (gi·∫£ ƒë·ªãnh th√†nh c√¥ng)
                        localStorage.setItem("paymentSuccess", "true");
                        window.location.href = "index.html";
                    }
                }
            }, 2000); // Ki·ªÉm tra m·ªói 2 gi√¢y
        }

        // Ch√®n chatbox v√†o trang
        fetch('chatbox-component.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('chatbox-container').innerHTML = data;
                // Sau khi ch√®n, t·∫£i l·ªãch s·ª≠ tr√≤ chuy·ªán
                if (typeof loadChatHistory === 'function') {
                    loadChatHistory();
                }
                // Kh√¥i ph·ª•c tr·∫°ng th√°i hi·ªÉn th·ªã c·ªßa chatbox
                const isChatbotOpen = localStorage.getItem('chatbotOpen') === 'true';
                if (isChatbotOpen) {
                    document.body.classList.add('show-chatbot');
                }
            })
            .catch(error => {
                console.error("L·ªói khi t·∫£i chatbox-component.html:", error);
            });
    </script>
</body>
</html>