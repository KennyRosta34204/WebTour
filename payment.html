<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh To√°n ZaloPay</title>
    <link rel="stylesheet" href="css/payment.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <link rel="stylesheet" href="css/payment-chatbox.css">
    <style>
        #payment-button { background-color: #6a1b9a; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; position: relative; }
        #payment-button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #qrcode-container { margin-top: 20px; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: inline-block; }
        #qrcode-container h3 { margin: 0 0 10px 0; color: #333; }
        #qrcode-container p { margin: 0 0 10px 0; color: #666; font-size: 14px; }
        #qrcode { text-align: center; }
        #qrcode canvas { max-width: 200px; }
        .loading-spinner { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 4px solid #f3f3f3; border-top: 4px solid #6a1b9a; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        .status-message { margin-top: 20px; padding: 10px; border-radius: 5px; }
        .status-message.success { background-color: #e0ffe0; color: #2e7d32; }
        .status-message.error { background-color: #ffe0e0; color: #d32f2f; }
        .status-message.info { background-color: #e0f7fa; color: #0277bd; }
    </style>
</head>
<body>
    <nav class="main-nav">
        <a href="index.html">Trang ch·ªß</a>
        <a href="about.html">Gi·ªõi thi·ªáu</a>
        <a href="services.html">D·ªãch v·ª•</a>
        <a href="contact.html">Li√™n h·ªá</a>
    </nav>

    <h2>Thanh To√°n Tour Du L·ªãch</h2>

    <div id="tour-info">
        <img id="tour-image" src="" alt="H√¨nh ·∫£nh tour" width="300">
        <p><strong>T√™n tour:</strong> <span id="tour-name"></span></p>
        <p><strong>Gi√° ti·ªÅn:</strong> <span id="tour-price"></span> VND</p>
        <p><strong>T√™n ng∆∞·ªùi d√πng:</strong> <span id="user-name"></span></p>
        <p><strong>Email:</strong> <span id="user-email"></span></p>
        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="user-phone"></span></p>
    </div>

    <button id="payment-button" onclick="createOrder()">
        Thanh To√°n
        <span class="loading-spinner"></span>
    </button>
    <div id="qrcode-container" style="display: none;">
        <h3>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n qua ZaloPay</h3>
        <p>Vui l√≤ng m·ªü ·ª©ng d·ª•ng ZaloPay v√† qu√©t m√£ QR b√™n d∆∞·ªõi ƒë·ªÉ ho√†n t·∫•t thanh to√°n.</p>
        <div id="qrcode"></div>
        <a id="open-zalopay" href="#" target="_blank">M·ªü ZaloPay ƒë·ªÉ thanh to√°n (n·∫øu kh√¥ng qu√©t ƒë∆∞·ª£c m√£ QR)</a>
    </div>
    <script>
        // Bi·∫øn ƒë·ªÉ theo d√µi tr·∫°ng th√°i y√™u c·∫ßu
        let isProcessing = false;
        let pollingInterval = null;
        let retryCount = 0;
        const maxRetries = 5; // S·ªë l·∫ßn th·ª≠ l·∫°i t·ªëi ƒëa khi ki·ªÉm tra tr·∫°ng th√°i

        // H√†m ki·ªÉm tra k·∫øt n·ªëi m·∫°ng
        function checkNetwork() {
            return navigator.onLine;
        }

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o tr·∫°ng th√°i
        function showStatusMessage(message, type = 'info') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
        }

        // H√†m chuy·ªÉn h∆∞·ªõng sau khi ki·ªÉm tra trang
        async function redirectAfterCheck(url) {
            const pageExists = await checkPageExists(url);
            window.location.href = pageExists ? url : "/";
        }

        // Load th√¥ng tin tour v√† ng∆∞·ªùi d√πng khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener("DOMContentLoaded", function() {
            const user_id = localStorage.getItem("user_id");
            if (!user_id) {
                showStatusMessage("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thanh to√°n!", "error");
                setTimeout(() => {
                    window.location.href = "login.html";
                }, 2000);
                return;
            }

            let tourData;
            try {
                const rawTourData = localStorage.getItem("selectedTour");
                if (!rawTourData) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu tour trong localStorage!");
                }
                tourData = JSON.parse(rawTourData);
                if (!tourData || typeof tourData !== "object") {
                    throw new Error("D·ªØ li·ªáu tour kh√¥ng h·ª£p l·ªá!");
                }
            } catch (error) {
                console.error("‚ùå L·ªói khi ƒë·ªçc d·ªØ li·ªáu tour:", error.message);
                showStatusMessage(error.message, "error");
                setTimeout(() => {
                    window.location.href = "services.html";
                }, 2000);
                return;
            }

            // Ki·ªÉm tra xem tourData c√≥ id ho·∫∑c product_id kh√¥ng
            const tourId = tourData.id || tourData.product_id;
            if (!tourId) {
                console.error("‚ùå D·ªØ li·ªáu tour thi·∫øu id ho·∫∑c product_id:", tourData);
                showStatusMessage("D·ªØ li·ªáu tour thi·∫øu th√¥ng tin ID. Vui l√≤ng ch·ªçn l·∫°i tour!", "error");
                setTimeout(() => {
                    window.location.href = "services.html";
                }, 2000);
                return;
            }

            console.log("‚úÖ D·ªØ li·ªáu tourData:", tourData);

            // Hi·ªÉn th·ªã th√¥ng tin tour v√† ng∆∞·ªùi d√πng
            document.getElementById("tour-name").textContent = tourData.title || "Kh√¥ng c√≥ th√¥ng tin";
            const price = parseInt(tourData.price?.replace(/\D/g, '') || '0');
            document.getElementById("tour-price").textContent = price.toLocaleString('vi-VN');
            document.getElementById("user-name").textContent = tourData.name || "Kh√¥ng c√≥ th√¥ng tin";
            document.getElementById("user-email").textContent = tourData.email || "Kh√¥ng c√≥ th√¥ng tin";
            document.getElementById("user-phone").textContent = tourData.phone || "Kh√¥ng c√≥ th√¥ng tin";

            const tourImage = document.getElementById("tour-image");
            const defaultImage = "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80";
            tourImage.src = tourData.url || tourData.image || defaultImage;
            tourImage.onerror = function() {
                console.error("Kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh:", tourData.image);
                this.src = defaultImage;
            };

            // Ki·ªÉm tra n·∫øu c√≥ app_trans_id t·ª´ tr∆∞·ªõc (tr∆∞·ªùng h·ª£p ng∆∞·ªùi d√πng quay l·∫°i trang)
            const app_trans_id = localStorage.getItem("lastTransactionId");
            if (app_trans_id) {
                checkPaymentStatus(app_trans_id);
            }
        });

        async function createOrder() {
            // NgƒÉn g·ª≠i y√™u c·∫ßu n·∫øu ƒëang x·ª≠ l√Ω
            if (isProcessing) {
                showStatusMessage("ƒêang x·ª≠ l√Ω giao d·ªãch. Vui l√≤ng ch·ªù!", "info");
                return;
            }

            const paymentButton = document.getElementById("payment-button");
            const loadingSpinner = paymentButton.querySelector(".loading-spinner");
            const qrCodeContainer = document.getElementById("qrcode-container");

            if (!checkNetwork()) {
                showStatusMessage("Kh√¥ng c√≥ k·∫øt n·ªëi internet. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi v√† th·ª≠ l·∫°i!", "error");
                return;
            }

            paymentButton.disabled = true;
            paymentButton.textContent = "ƒêang x·ª≠ l√Ω...";
            loadingSpinner.style.display = "block";
            isProcessing = true;

            let tourData;
            try {
                const rawTourData = localStorage.getItem("selectedTour");
                if (!rawTourData) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu tour trong localStorage!");
                }
                tourData = JSON.parse(rawTourData);
                if (!tourData || typeof tourData !== "object") {
                    throw new Error("D·ªØ li·ªáu tour kh√¥ng h·ª£p l·ªá!");
                }
            } catch (error) {
                console.error("‚ùå L·ªói khi ƒë·ªçc d·ªØ li·ªáu tour:", error.message);
                showStatusMessage(error.message, "error");
                paymentButton.disabled = false;
                paymentButton.textContent = "Thanh To√°n";
                loadingSpinner.style.display = "none";
                isProcessing = false;
                return;
            }

            try {
                const product_id = tourData.id || tourData.product_id; // H·ªó tr·ª£ c·∫£ id v√† product_id
                if (!product_id) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y ID tour trong d·ªØ li·ªáu tour");
                }

                const userInfo = {
                    name: tourData.name || "Kh√°ch h√†ng",
                    email: tourData.email || "khachhang@example.com",
                    phone: tourData.phone || "0123456789"
                };

                const user_id = localStorage.getItem("user_id");
                if (!user_id) {
                    throw new Error("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c!");
                }

                // Ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(userInfo.email)) {
                    throw new Error("Email kh√¥ng h·ª£p l·ªá!");
                }
                const phoneRegex = /^\d{10,15}$/;
                if (!phoneRegex.test(userInfo.phone)) {
                    throw new Error("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (ph·∫£i c√≥ 10-15 ch·ªØ s·ªë)!");
                }

                console.log("üì§ D·ªØ li·ªáu g·ª≠i ƒëi:", { product_id, userInfo, user_id });

                // Ki·ªÉm tra tr·∫°ng th√°i giao d·ªãch tr∆∞·ªõc khi g·ª≠i y√™u c·∫ßu m·ªõi
                const checkResponse = await fetch(`http://localhost:5500/check-transaction-status`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id, product_id })
                });

                if (checkResponse.ok) {
                    const checkResult = await checkResponse.json();
                    if (checkResult.status === "PENDING") {
                        throw new Error("Giao d·ªãch ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω. Vui l√≤ng th·ª≠ l·∫°i sau 1-2 ph√∫t!");
                    }
                } else {
                    console.warn("Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i giao d·ªãch. Ti·∫øp t·ª•c t·∫°o ƒë∆°n h√†ng...");
                }

                const response = await fetch("http://localhost:5500/create-order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ product_id, userInfo, user_id })
                });

                const responseText = await response.text();
                console.log("üì© Ph·∫£n h·ªìi t·ª´ server (text):", responseText);

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                        if (errorData.details === "Transaction already in progress") {
                            throw new Error("Giao d·ªãch ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω. Vui l√≤ng th·ª≠ l·∫°i sau 1-2 ph√∫t!");
                        }
                        throw new Error(errorData.error || `L·ªói server: ${response.status}`);
                    } catch (e) {
                        throw new Error(`L·ªói server: ${response.status} - ${responseText}`);
                    }
                }

                const result = JSON.parse(responseText);
                console.log("üì© Ph·∫£n h·ªìi t·ª´ server (JSON):", result);

                if (result.order_url) {
                    console.log("‚úÖ T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng! Hi·ªÉn th·ªã m√£ QR ZaloPay...");
                    const qrCodeDiv = document.getElementById("qrcode");
                    qrCodeDiv.innerHTML = "";
                    QRCode.toCanvas(result.order_url, { width: 200 }, function (error, canvas) {
                        if (error) {
                            console.error("L·ªói khi t·∫°o m√£ QR:", error);
                            throw new Error("Kh√¥ng th·ªÉ t·∫°o m√£ QR!");
                        }
                        qrCodeDiv.appendChild(canvas);
                    });

                    qrCodeContainer.style.display = "block";
                    const openZaloPayLink = document.getElementById("open-zalopay");
                    openZaloPayLink.href = result.order_url;
                    paymentButton.textContent = "Thanh To√°n L·∫°i";
                    showStatusMessage("Vui l√≤ng qu√©t m√£ QR ƒë·ªÉ thanh to√°n!", "info");

                    const app_trans_id = result.app_trans_id;
                    if (app_trans_id) {
                        localStorage.setItem("lastTransactionId", app_trans_id);
                        localStorage.setItem("lastOrderId", result.order_id); // L∆∞u order_id
                        checkPaymentStatus(app_trans_id);
                    } else {
                        console.warn("Kh√¥ng t√¨m th·∫•y app_trans_id trong ph·∫£n h·ªìi!");
                        showStatusMessage("Kh√¥ng t√¨m th·∫•y m√£ giao d·ªãch. Vui l√≤ng th·ª≠ l·∫°i!", "error");
                    }
                } else {
                    throw new Error(result.error || "T·∫°o ƒë∆°n h√†ng th·∫•t b·∫°i: Kh√¥ng c√≥ order_url!");
                }
            } catch (error) {
                console.error("‚ùå L·ªói chi ti·∫øt:", error.stack);
                showStatusMessage(error.message || "Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi server. Vui l√≤ng th·ª≠ l·∫°i sau!", "error");
                paymentButton.textContent = "Thanh To√°n";
            } finally {
                paymentButton.disabled = false;
                loadingSpinner.style.display = "none";
                isProcessing = false;
            }
        }

        async function checkPageExists(url) {
            try {
                const response = await fetch(url, { method: "HEAD" });
                return response.ok;
            } catch (e) {
                console.error("‚ùå Kh√¥ng th·ªÉ ki·ªÉm tra trang:", e);
                return false;
            }
        }

        async function checkPaymentStatus(app_trans_id) {
            let attempts = 0;
            const maxAttempts = 60; // 5 ph√∫t
            const intervalTime = 5000; // 5 gi√¢y

            // D·ª´ng polling n·∫øu ƒë√£ c√≥ interval ch·∫°y
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            pollingInterval = setInterval(async () => {
                attempts++;
                console.log(`üìã L·∫ßn th·ª≠ ${attempts}/${maxAttempts} - Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng...`);

                // Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng tr∆∞·ªõc khi g·ªçi API
                if (!checkNetwork()) {
                    retryCount++;
                    showStatusMessage(`Kh√¥ng c√≥ k·∫øt n·ªëi internet. ƒêang th·ª≠ l·∫°i... (${retryCount}/${maxRetries})`, "error");
                    if (retryCount >= maxRetries) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        showStatusMessage("Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i do m·∫•t k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra l·∫°i sau!", "error");
                        localStorage.setItem("paymentSuccess", "error");
                        setTimeout(() => {
                            redirectAfterCheck("/index.html");
                        }, 2000);
                    }
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:5500/order-status/${app_trans_id}`, {
                        method: "GET",
                        headers: { "Content-Type": "application/json" }
                    });

                    if (!response.ok) {
                        throw new Error(`Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log("üìã Tr·∫°ng th√°i ƒë∆°n h√†ng t·ª´ server:", data);
                    retryCount = 0; // Reset s·ªë l·∫ßn th·ª≠ l·∫°i n·∫øu th√†nh c√¥ng

                    // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒë∆°n h√†ng
                    showStatusMessage(data.message || `Tr·∫°ng th√°i ƒë∆°n h√†ng: ${data.status}`, data.status === "SUCCESS" ? "success" : "info");

                    if (data.status === "SUCCESS") {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        console.log("‚úÖ Thanh to√°n th√†nh c√¥ng!");
                        localStorage.setItem("paymentSuccess", "true");
                        localStorage.setItem("lastTransactionId", app_trans_id);
                        localStorage.setItem("lastOrderId", data.order_id); // L∆∞u order_id t·ª´ ph·∫£n h·ªìi
                        localStorage.removeItem("selectedTour");
                        showStatusMessage(data.message || "Thanh to√°n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª•.", "success");
                        setTimeout(() => {
                            redirectAfterCheck("/index.html");
                        }, 2000);
                    } else if (data.status === "FAILED") {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        console.log("‚ùå Thanh to√°n th·∫•t b·∫°i!");
                        showStatusMessage("Thanh to√°n th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i!", "error");
                        localStorage.setItem("paymentSuccess", "false");
                    } else if (attempts >= maxAttempts) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        console.log("‚è∞ H·∫øt th·ªùi gian ch·ªù!");
                        showStatusMessage("H·∫øt th·ªùi gian x√°c nh·∫≠n thanh to√°n. Vui l√≤ng ki·ªÉm tra l·∫°i.", "error");
                        localStorage.setItem("paymentSuccess", "pending");
                        setTimeout(() => {
                            redirectAfterCheck("/index.html");
                        }, 2000);
                    }
                } catch (error) {
                    console.error("‚ùå L·ªói khi ki·ªÉm tra tr·∫°ng th√°i:", error.message);
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        showStatusMessage("Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng sau nhi·ªÅu l·∫ßn th·ª≠. Vui l√≤ng li√™n h·ªá h·ªó tr·ª£.", "error");
                        localStorage.setItem("paymentSuccess", "error");
                        setTimeout(() => {
                            redirectAfterCheck("/index.html");
                        }, 2000);
                    } else {
                        showStatusMessage(`L·ªói: ${error.message}. ƒêang th·ª≠ l·∫°i... (${retryCount}/${maxRetries})`, "error");
                    }
                }
            }, intervalTime);
        }
    </script>
</body>
</html>