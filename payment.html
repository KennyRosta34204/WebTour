<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán ZaloPay</title>
    <link rel="stylesheet" href="css/payment.css">
    <!-- Thêm Font Awesome để hiển thị icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Thêm thư viện qrcode để tạo mã QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <link rel="stylesheet" href="css/chatbox.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />
    <style>
        #payment-button {
            background-color: #6a1b9a;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            position: relative;
        }
        #payment-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #qrcode-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }
        #qrcode-container h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        #qrcode-container p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        #qrcode {
            text-align: center;
        }
        #qrcode canvas {
            max-width: 200px;
        }
        .loading-spinner {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6a1b9a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="main-nav">
        <a href="index.html">Trang chủ</a>
        <a href="about.html">Giới thiệu</a>
        <a href="services.html">Dịch vụ</a>
        <a href="contact.html">Liên hệ</a>
        <i class="fa-solid fa-user"></i>
    </nav>

    <h2>Thanh Toán Tour Du Lịch</h2>

    <div id="tour-info">
        <img id="tour-image" src="" alt="Hình ảnh tour" width="300">
        <p><strong>Tên tour:</strong> <span id="tour-name"></span></p>
        <p><strong>Giá tiền:</strong> <span id="tour-price"></span> VND</p>
        <p><strong>Tên người dùng:</strong> <span id="user-name"></span></p>
        <p><strong>Email:</strong> <span id="user-email"></span></p>
        <p><strong>Số điện thoại:</strong> <span id="user-phone"></span></p>
    </div>

    <button id="payment-button" onclick="createOrder()">
        Thanh Toán
        <span class="loading-spinner"></span>
    </button>
    <div id="qrcode-container" style="display: none;">
        <h3>Quét mã QR để thanh toán qua ZaloPay</h3>
        <p>Vui lòng mở ứng dụng ZaloPay và quét mã QR bên dưới để hoàn tất thanh toán.</p>
        <div id="qrcode"></div>
        <a id="open-zalopay" href="#" target="_blank">Mở ZaloPay để thanh toán (nếu không quét được mã QR)</a>
    </div>

    <div id="chatbox-container"></div>

    <script>
        // Kiểm tra kết nối mạng
        function checkNetwork() {
            return navigator.onLine;
        }

        // Đảm bảo người dùng phải đăng nhập trước khi thanh toán
        document.addEventListener("DOMContentLoaded", function() {
            // Kiểm tra trạng thái đăng nhập
            const user_id = localStorage.getItem("user_id");
            if (!user_id) {
                alert("Bạn cần đăng nhập để thực hiện thanh toán!");
                window.location.href = "login.html"; // Chuyển hướng đến trang đăng nhập
                return;
            }

            // Tiếp tục hiển thị thông tin tour
            const tourData = JSON.parse(localStorage.getItem("selectedTour"));
            if (!tourData || !tourData.product_id) {
                alert("Không có tour nào được chọn hoặc thiếu thông tin tour!");
                window.location.href = "services.html"; // Chuyển hướng về trang danh sách tour
                return;
            }

            console.log("Dữ liệu tourData:", tourData);

            // Hiển thị thông tin tour
            document.getElementById("tour-name").textContent = tourData.title || "Không có thông tin";
            
            // Định dạng giá tiền
            const price = parseInt(tourData.price?.replace(/\D/g, '') || '0');
            document.getElementById("tour-price").textContent = price.toLocaleString('vi-VN');

            // Hiển thị thông tin người dùng
            document.getElementById("user-name").textContent = tourData.name || "Không có thông tin";
            document.getElementById("user-email").textContent = tourData.email || "Không có thông tin";
            document.getElementById("user-phone").textContent = tourData.phone || "Không có thông tin";

            // Hiển thị hình ảnh tour
            const tourImage = document.getElementById("tour-image");
            const defaultImage = "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80";
            tourImage.src = tourData.image || defaultImage;
            tourImage.onerror = function() {
                console.error("Không tải được ảnh:", tourData.image);
                this.src = defaultImage;
            };

            // Xử lý chatbox
            const chatbotToggler = document.querySelector(".chatbot-toggler");
            const chatbot = document.querySelector(".chatbot");
            const closeBtn = document.querySelector(".close-btn");
            const sendBtn = document.getElementById("send-btn");
            const chatInput = document.querySelector(".chat-input textarea");
            const chatbox = document.querySelector(".chatbox");

            if (chatbotToggler && chatbot) {
                chatbotToggler.addEventListener("click", () => {
                    chatbot.classList.toggle("active");
                });
            } else {
                console.error("Không tìm thấy chatbotToggler hoặc chatbot");
            }

            if (closeBtn && chatbot) {
                closeBtn.addEventListener("click", () => {
                    chatbot.classList.remove("active");
                });
            } else {
                console.error("Không tìm thấy closeBtn hoặc chatbot");
            }

            if (sendBtn && chatInput && chatbox) {
                sendBtn.addEventListener("click", () => {
                    const message = chatInput.value.trim();
                    if (message) {
                        const outgoingMsg = document.createElement("li");
                        outgoingMsg.classList.add("chat", "outgoing");
                        outgoingMsg.innerHTML = `<p>${message}</p>`;
                        chatbox.appendChild(outgoingMsg);
                        chatInput.value = "";
                        chatbox.scrollTop = chatbox.scrollHeight;

                        setTimeout(() => {
                            const incomingMsg = document.createElement("li");
                            incomingMsg.classList.add("chat", "incoming");
                            incomingMsg.innerHTML = `<span class="material-symbols-outlined">smart_toy</span><p>Đang xử lý...</p>`;
                            chatbox.appendChild(incomingMsg);
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }, 600);
                    }
                });

                // Thêm sự kiện Enter để gửi tin nhắn
                chatInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendBtn.click();
                    }
                });
            } else {
                console.error("Không tìm thấy sendBtn, chatInput hoặc chatbox");
            }
        });

        // Hàm tạo đơn hàng và xử lý thanh toán
        async function createOrder() {
            const paymentButton = document.getElementById("payment-button");
            const loadingSpinner = paymentButton.querySelector(".loading-spinner");
            const qrCodeContainer = document.getElementById("qrcode-container");

            // Kiểm tra kết nối mạng
            if (!checkNetwork()) {
                alert("Không có kết nối internet. Vui lòng kiểm tra kết nối và thử lại!");
                return;
            }

            paymentButton.disabled = true;
            paymentButton.textContent = "Đang xử lý...";
            loadingSpinner.style.display = "block";

            const tourData = JSON.parse(localStorage.getItem("selectedTour"));
            if (!tourData) {
                alert("Không có dữ liệu tour!");
                paymentButton.disabled = false;
                paymentButton.textContent = "Thanh Toán";
                loadingSpinner.style.display = "none";
                return;
            }

            try {
                // Kiểm tra product_id
                const product_id = tourData.product_id;
                if (!product_id) {
                    throw new Error("Không tìm thấy product_id trong dữ liệu tour");
                }

                // Kiểm tra thông tin người dùng
                const userInfo = {
                    name: tourData.name || "Khách hàng",
                    email: tourData.email || "khachhang@example.com",
                    phone: tourData.phone || "0123456789"
                };

                if (!userInfo.name || !userInfo.email || !userInfo.phone) {
                    throw new Error("Thông tin người dùng không đầy đủ. Vui lòng kiểm tra lại!");
                }

                // Kiểm tra định dạng email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(userInfo.email)) {
                    throw new Error("Email không hợp lệ!");
                }

                // Kiểm tra định dạng số điện thoại
                const phoneRegex = /^\d{10,15}$/;
                if (!phoneRegex.test(userInfo.phone)) {
                    throw new Error("Số điện thoại không hợp lệ (phải có 10-15 chữ số)!");
                }

                // Lấy user_id từ localStorage
                const user_id = localStorage.getItem("user_id");
                if (!user_id) {
                    throw new Error("Bạn chưa đăng nhập. Vui lòng đăng nhập để tiếp tục!");
                }

                console.log("📤 Gửi yêu cầu tạo đơn hàng:", { product_id, userInfo, user_id });

                const response = await fetch("http://localhost:5500/create-order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ product_id, userInfo, user_id })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Lỗi không xác định từ server");
                }

                const result = await response.json();
                console.log("📩 Phản hồi từ backend:", result);

                if (result.order_url) {
                    console.log("✅ Tạo đơn hàng thành công! Hiển thị mã QR ZaloPay...");
                    // Hiển thị mã QR
                    const qrCodeDiv = document.getElementById("qrcode");
                    qrCodeDiv.innerHTML = ""; // Xóa mã QR cũ (nếu có)
                    QRCode.toCanvas(result.order_url, { width: 200 }, function (error, canvas) {
                        if (error) {
                            console.error("Lỗi khi tạo mã QR:", error);
                            throw new Error("Không thể tạo mã QR!");
                        }
                        qrCodeDiv.appendChild(canvas);
                    });

                    // Hiển thị container chứa mã QR
                    qrCodeContainer.style.display = "block";

                    // Cập nhật liên kết mở ZaloPay
                    const openZaloPayLink = document.getElementById("open-zalopay");
                    openZaloPayLink.href = result.order_url;

                    // Cập nhật nút thanh toán
                    paymentButton.textContent = "Thanh Toán Lại";

                    // Kiểm tra trạng thái thanh toán định kỳ
                    const app_trans_id = result.app_trans_id;
                    checkPaymentStatus(app_trans_id);
                } else {
                    throw new Error(result.error || "Tạo đơn hàng thất bại!");
                }
            } catch (error) {
                console.error("❌ Lỗi hệ thống:", error.message);
                alert(`Lỗi: ${error.message}`);
                paymentButton.textContent = "Thanh Toán";
            } finally {
                paymentButton.disabled = false;
                loadingSpinner.style.display = "none";
            }
        }

        // Hàm kiểm tra trạng thái thanh toán
        async function checkPaymentStatus(app_trans_id) {
            let attempts = 0;
            const maxAttempts = 30; // Tối đa 30 lần thử (60 giây)

            const interval = setInterval(async () => {
                attempts++;
                console.log(`📋 Lần thử ${attempts}/${maxAttempts} - Kiểm tra trạng thái đơn hàng...`);

                try {
                    const response = await fetch(`http://localhost:5500/order-status/${app_trans_id}`);
                    if (!response.ok) {
                        throw new Error(`Không thể kiểm tra trạng thái đơn hàng: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log("📋 Trạng thái đơn hàng:", data);

                    if (data.status === "SUCCESS") {
                        clearInterval(interval); // Dừng kiểm tra định kỳ
                        console.log("✅ Thanh toán thành công! Chuyển hướng về trang chủ...");
                        // Lưu trạng thái thanh toán thành công vào localStorage
                        localStorage.setItem("paymentSuccess", "true");
                        // Chuyển hướng về trang chủ
                        window.location.href = "index.html";
                    } else if (data.status === "FAILED") {
                        clearInterval(interval); // Dừng kiểm tra định kỳ
                        console.log("❌ Thanh toán thất bại!");
                        alert("Thanh toán thất bại. Vui lòng thử lại!");
                    } else if (attempts >= maxAttempts) {
                        clearInterval(interval); // Dừng kiểm tra nếu vượt quá số lần thử
                        console.log("⏰ Hết thời gian chờ! Chuyển hướng thủ công về trang chủ...");
                        alert("Không thể xác nhận trạng thái thanh toán. Bạn sẽ được chuyển về trang chủ.");
                        // Lưu trạng thái thanh toán thành công vào localStorage (giả định thành công)
                        localStorage.setItem("paymentSuccess", "true");
                        window.location.href = "index.html";
                    }
                    // Nếu trạng thái là PENDING, tiếp tục kiểm tra
                } catch (error) {
                    console.error("❌ Lỗi khi kiểm tra trạng thái:", error.message);
                    if (attempts >= maxAttempts) {
                        clearInterval(interval); // Dừng kiểm tra nếu vượt quá số lần thử
                        console.log("⏰ Hết thời gian chờ do lỗi! Chuyển hướng thủ công về trang chủ...");
                        alert("Có lỗi xảy ra khi kiểm tra trạng thái thanh toán. Bạn sẽ được chuyển về trang chủ.");
                        // Lưu trạng thái thanh toán thành công vào localStorage (giả định thành công)
                        localStorage.setItem("paymentSuccess", "true");
                        window.location.href = "index.html";
                    }
                }
            }, 2000); // Kiểm tra mỗi 2 giây
        }

        // Chèn chatbox vào trang
        fetch('chatbox-component.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('chatbox-container').innerHTML = data;
                // Sau khi chèn, tải lịch sử trò chuyện
                if (typeof loadChatHistory === 'function') {
                    loadChatHistory();
                }
                // Khôi phục trạng thái hiển thị của chatbox
                const isChatbotOpen = localStorage.getItem('chatbotOpen') === 'true';
                if (isChatbotOpen) {
                    document.body.classList.add('show-chatbot');
                }
            })
            .catch(error => {
                console.error("Lỗi khi tải chatbox-component.html:", error);
            });
    </script>
</body>
</html>